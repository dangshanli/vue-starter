(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{429:function(s,a,t){"use strict";t.r(a);var e=t(62),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"redis配置以及基准测试文档"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#redis配置以及基准测试文档"}},[s._v("#")]),s._v(" redis配置以及基准测试文档")]),s._v(" "),t("p"),t("div",{staticClass:"table-of-contents"},[t("ul",[t("li",[t("a",{attrs:{href:"#★前置环境以及相关配置"}},[s._v("★前置环境以及相关配置")]),t("ul",[t("li",[t("a",{attrs:{href:"#平台环境"}},[s._v("平台环境")])]),t("li",[t("a",{attrs:{href:"#redis专属配置"}},[s._v("Redis专属配置")])])])]),t("li",[t("a",{attrs:{href:"#★基准测试以及结果展示"}},[s._v("★基准测试以及结果展示")]),t("ul",[t("li",[t("a",{attrs:{href:"#测试指令以及相关参数说明"}},[s._v("测试指令以及相关参数说明")])]),t("li",[t("a",{attrs:{href:"#结果展示"}},[s._v("结果展示")])])])])])]),t("p"),s._v(" "),t("h2",{attrs:{id:"★前置环境以及相关配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#★前置环境以及相关配置"}},[s._v("#")]),s._v(" ★前置环境以及相关配置")]),s._v(" "),t("h3",{attrs:{id:"平台环境"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#平台环境"}},[s._v("#")]),s._v(" 平台环境")]),s._v(" "),t("p",[t("strong",[s._v("k8s部署平台")]),s._v(":")]),s._v(" "),t("ul",[t("li",[t("p",[s._v("master "),t("code",[s._v("10.0.108.11")])])]),s._v(" "),t("li",[t("p",[s._v("node "),t("code",[s._v("10.0.108.12")])])])]),s._v(" "),t("p",[t("strong",[s._v("redis statefule容器资源配置")]),s._v("：")]),s._v(" "),t("div",{staticClass:"language-yaml extra-class"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[s._v("          "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("resources")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("limits")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n              "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'4'")]),s._v("\n              "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 8Gi\n            "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("requests")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n              "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cpu")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'4'")]),s._v("\n              "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("memory")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 4Gi\n")])])]),t("p",[t("strong",[s._v("永久持久化位置为nfs服务")]),s._v("，地址为：")]),s._v(" "),t("div",{staticClass:"language-yaml extra-class"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[s._v("  "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("nfs")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("path")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" /data/k8s/redis/kcsp\n    "),t("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("server")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" 10.0.108.11\n")])])]),t("p",[s._v("关闭透明内存大页("),t("code",[s._v("THP")]),s._v(")，同时设置"),t("code",[s._v("somaxconn")]),s._v("为4096，以满足redis的基本部署需求")]),s._v(" "),t("p",[t("strong",[s._v("预填充数据")]),s._v("400万，初始内存占用300M，为后续压测预留一定空间：")]),s._v(" "),t("div",{staticClass:"language-properties extra-class"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Keyspace")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("db0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("keys=4200003,expires=4000001,avg_ttl=33874581")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Memory")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("used_memory")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("380121856")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("used_memory_human")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("362.51M")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("used_memory_rss")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("394067968")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("used_memory_rss_human")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("375.81M")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("used_memory_peak")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("380307328")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("used_memory_peak_human")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("362.69M")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("used_memory_peak_perc")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("99.95%")]),s._v("\n")])])]),t("h3",{attrs:{id:"redis专属配置"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#redis专属配置"}},[s._v("#")]),s._v(" Redis专属配置")]),s._v(" "),t("div",{staticClass:"language-properties extra-class"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    save")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("600 1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    stop-writes-on-bgsave-error")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("yes")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    rdbcompression")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("yes")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    rdbchecksum")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("yes")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    dbfilename")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("dump_pv.rdb")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    dir")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("/data")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    aof-use-rdb-preamble")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("no")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    maxmemory")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("7168mb")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("    maxmemory-policy")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("allkeys-lru")]),s._v("\n")])])]),t("p",[t("strong",[s._v("简单说明")]),s._v("：")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("最低10min持久化一次，持久化错误则关闭写入能力（因为这是服务出现问题的迹象）")])]),s._v(" "),t("li",[t("p",[s._v("rdb文件压缩以及校验和开启")])]),s._v(" "),t("li",[t("p",[s._v("配置关闭混合持久化模式（5.x以后版本默认打开）")])]),s._v(" "),t("li",[t("p",[s._v("redis最大内存使用限制在7G，超过最大内存启用LRU过期策略")])])]),s._v(" "),t("p",[t("strong",[s._v("相关部署文件")]),s._v("可参见"),t("code",[s._v("10.0.108.11")]),s._v("节点下"),t("code",[s._v("/home/ranni/appyaml/redis-all.yaml")]),s._v("文件。")]),s._v(" "),t("h2",{attrs:{id:"★基准测试以及结果展示"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#★基准测试以及结果展示"}},[s._v("#")]),s._v(" ★基准测试以及结果展示")]),s._v(" "),t("h3",{attrs:{id:"测试指令以及相关参数说明"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#测试指令以及相关参数说明"}},[s._v("#")]),s._v(" 测试指令以及相关参数说明")]),s._v(" "),t("p",[s._v("基准测试使用官方提供的"),t("code",[s._v("benchmark")]),s._v("工具，")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("./redis-benchmark -a "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("123456")]),s._v(" -r "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("100000")]),s._v(" -n "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("500000")]),s._v(" -t set,get,hset\n -l "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" /data/pod-inner-513.log "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n")])])]),t("p",[s._v("简单说明：")]),s._v(" "),t("ul",[t("li",[s._v("使用10万随机key做查询，模仿真实情况，每个方法单轮操作50万次")]),s._v(" "),t("li",[s._v("默认50并发线程，关闭pipeline选项，凸显时延影响")]),s._v(" "),t("li",[s._v("测试时长30+min")]),s._v(" "),t("li",[s._v("只针对kcsp项目中常用的"),t("code",[s._v("set")]),s._v("、"),t("code",[s._v("get")]),s._v("、"),t("code",[s._v("hset")]),s._v("几个操作测试")]),s._v(" "),t("li",[s._v("日志写到nfs盘的"),t("code",[s._v("pod-inner-513.log")]),s._v("，后面会提供一个可供查阅的地址")]),s._v(" "),t("li",[s._v("使用默认payload，为3byte")])]),s._v(" "),t("p",[s._v("备注：本次测试为进入Pod内部指令测试，并非使用NodePort端口转发的方式。")]),s._v(" "),t("h3",{attrs:{id:"结果展示"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#结果展示"}},[s._v("#")]),s._v(" 结果展示")]),s._v(" "),t("p",[s._v("测试后，redis内存占用约"),t("code",[s._v("1.48G")]),s._v("：")]),s._v(" "),t("div",{staticClass:"language-properties extra-class"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Memory")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("used_memory")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("1587152752")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("used_memory_human")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("1.48G")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("used_memory_rss")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("1744109568")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("used_memory_rss_human")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("1.62G")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("used_memory_peak")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("1590246536")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("used_memory_peak_human")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("1.48G")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("used_memory_peak_perc")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("99.81%")]),s._v("\n")])])]),t("hr"),s._v(" "),t("p",[s._v("最近一次fork耗时为"),t("code",[s._v("5ms")]),s._v(":")]),s._v(" "),t("div",{staticClass:"language-properties extra-class"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("latest_fork_usec")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("5954")]),s._v("\n")])])]),t("hr"),s._v(" "),t("div",{staticClass:"language-textile extra-class"},[t("pre",{pre:!0,attrs:{class:"language-textile"}},[t("code",[t("span",{pre:!0,attrs:{class:"token phrase"}},[s._v("SET: nan")]),s._v("\n\n  500000 requests completed in 11.02 seconds\n  50 parallel clients\n  3 bytes payload\n  keep alive: 1\n\n"),t("span",{pre:!0,attrs:{class:"token phrase"}},[s._v("98.31% <= 1 milliseconds\n99.92% <= 2 milliseconds\n100.00% <= 6 milliseconds\n100.00% <= 6 milliseconds\n45351.48 requests per second")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token phrase"}},[s._v("GET: 0.00")]),s._v("\n\n  500000 requests completed in 10.87 seconds\n  50 parallel clients\n  3 bytes payload\n  keep alive: 1\n\n"),t("span",{pre:!0,attrs:{class:"token phrase"}},[s._v("98.53% <= 1 milliseconds\n99.94% <= 2 milliseconds\n99.99% <= 4 milliseconds\n100.00% <= 5 milliseconds\n100.00% <= 5 milliseconds\n46015.09 requests per second")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token phrase"}},[s._v("HSET: 0.00")]),s._v("\n\n  500000 requests completed in 13.47 seconds\n  50 parallel clients\n  3 bytes payload\n  keep alive: 1\n\n"),t("span",{pre:!0,attrs:{class:"token phrase"}},[s._v("19.69% <= 1 milliseconds\n99.15% <= 2 milliseconds\n99.98% <= 3 milliseconds\n99.99% <= 4 milliseconds\n100.00% <= 5 milliseconds\n100.00% <= 6 milliseconds\n37114.02 requests per second\n")])])])]),t("p",[s._v("以上片段截取自记录文件，"),t("code",[s._v("set")]),s._v("、"),t("code",[s._v("get")]),s._v("总体qps在4万+，而"),t("code",[s._v("hset")]),s._v("总体稳在3万+。需要说明一下，这些数值仅仅只是参考，测试方式以及部署的硬件环境都会对最终结果产生巨大影响。以硬件而论，比如pod运行机器的cpu主频、是否支持超频，内存频率、颗粒好坏、是否双通道等皆有影响。笔者之前在"),t("code",[s._v("10.0.108.1")]),s._v("集群上部署，其qps测试结果总体为6万+左右，而当前笔者的集群机器"),t("code",[s._v("10.0.108.12")]),s._v("为长城提供的整机。所以对数据本身要理性看待。")]),s._v(" "),t("p",[s._v("就时延占比来看，"),t("code",[s._v("get")]),s._v("、"),t("code",[s._v("set")]),s._v("操做99%以上会集中在"),t("code",[s._v("1ms")]),s._v("时延，而更加复杂的"),t("code",[s._v("hset")]),s._v("操作99%的操作占比在"),t("code",[s._v("2ms")]),s._v("，总的来说三种操作99.9%的操作都会在"),t("code",[s._v("4ms")]),s._v("以内。")]),s._v(" "),t("p",[s._v("以上数据完整记录可参见"),t("code",[s._v("10.0.108.11")]),s._v("节点下"),t("code",[s._v("/home/ranni/pod-inner-513.log")]),s._v("文件。")])])}),[],!1,null,null,null);a.default=n.exports}}]);